#' @export
download_dbip_rvest_clean_v2 <- function() {

  # Подключаем библиотеку
  library(rvest)

  # Создаём папку для загрузок
  dir.create("data-raw/source", showWarnings = FALSE, recursive = TRUE)

  # 1. Функция для парсинга и очистки ссылки
  get_clean_url <- function(page_url, pattern) {

    page <- read_html(page_url)

    all_links <- page %>% html_nodes("a") %>% html_attr("href")
    print(head(all_links, 5))
    target_link <- grep(pattern, all_links, value = TRUE)[1]
    clean_url <- sub("(.*\\.gz).*", "\\1", url)
    return(clean_url)
  }

  # 2. Получаем чистые URL для двух файлов
  city_url <- get_clean_url("https://db-ip.com/db/download/ip-to-city-lite",
                            pattern = "dbip-city-lite")
  asn_url <- get_clean_url("https://db-ip.com/db/download/ip-to-asn-lite",
                           pattern = "dbip-asn-lite")

  # 3. Проверяем успешность
  if (is.na(city_url) || is.na(asn_url)) {
    stop("Не удалось извлечь одну или обе ссылки.")
  }

  # 4. Задаём пути для сохранения и скачиваем
  message("Скачиваю файл с геолокацией...")
  download.file(city_url, "data-raw/source/geo.csv.gz", mode = "wb")
  message("Скачиваю файл с ASN...")
  download.file(asn_url, "data-raw/source/asn.csv.gz", mode = "wb")

  message("✅ Оба файла успешно скачаны!")
  return(c(geo = "data-raw/source/geo.csv.gz", asn = "data-raw/source/asn.csv.gz"))
}
