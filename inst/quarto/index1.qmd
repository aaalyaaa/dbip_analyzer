---
title: "DB-IP Data Visualization"
format: html
---

```{r}
# Ищем demo.rda в текущей директории (он будет скопирован туда make_dashboard)
rda_path <- "data/demo.rda"

# Проверяем, что файл существует
if (!file.exists(rda_path)) {
  stop("Файл data/demo.rda не найден. Убедитесь, что make_dashboard() скопировала файл.")
}

# Загружаем данные из demo.rda
env <- new.env()
load(rda_path, envir = env)
data_name <- ls(env)[1]
demo_data <- get(data_name, envir = env)

cat("Загружены демо данные '", data_name, "'\n")
cat("Размер данных:", nrow(demo_data), "x", ncol(demo_data), "\n")

# Сохраняем как parquet
data_path <- file.path("data", "demo.parquet")

# Создаем папку data если ее нет (на всякий случай)
if (!dir.exists("data")) {
  dir.create("data", recursive = TRUE)
}

arrow::write_parquet(demo_data, data_path)
cat("Создан файл:", data_path, "\n")

# Загружаем данные для использования в дашборде
data <- arrow::read_parquet(data_path)

data <- dbipAnalyzer:::load_processed_data(data_path)
```
### Статистика
```{r}
#| echo: false
stats <-  invisible(dbipAnalyzer:::get_data_stats(data))
map_data <- head(data, 100000)  
ip_map <- dbipAnalyzer:::create_ip_map(map_data, 100000)
as_chart <- dbipAnalyzer:::create_as_org_chart(data, top_n = 15)
data_table <- dbipAnalyzer:::create_table(data, n = 200)
```
### Карта распределения IP - адресов (для первых 100000)
```{r}
#| echo: false
ip_map
```
### AS организаций по количеству IP-диапазонов
```{r}
#| echo: false
print(as_chart)
```
### Таблица данных DB-IP
```{r}
#| echo: false
data_table
```
